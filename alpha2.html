<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>âœ¨ NEONÂ·ALPHABET Â· fixed</title>
    <!-- Google Font & Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ---------- RESET & GLASS TOKENS ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --glass-bg: rgba(10, 20, 30, 0.6);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 20px 40px rgba(0,0,0,0.4);
            --blur-amount: 16px;
            
            /* CYBER default */
            --theme-gradient: linear-gradient(145deg, #0d1a2b, #0b121c);
            --grid-bg: #0a0e14;
            --grid-glow: 0 0 15px rgba(0, 255, 255, 0.3);
            --pixel-off: #1e2a36;
            --pixel-on: #00f0ff;
            --pixel-glow: 0 0 12px #00f0ff, 0 0 25px #00c8ff;
            --accent: #00f0ff;
            --accent-glow: 0 0 20px #00f0ff;
            --card-bg: rgba(20, 30, 45, 0.6);
            --text: #f0fcff;
            --text-secondary: #b0e0ff;
            --btn-bg: rgba(0, 240, 255, 0.1);
            --btn-border: rgba(0, 240, 255, 0.4);
            --btn-hover: rgba(0, 240, 255, 0.25);
            --bar-bg: #1e3a4a;
            --bar-fill: #00f0ff;
        }

        [data-theme="pink"] {
            --theme-gradient: linear-gradient(145deg, #281c2c, #1a121f);
            --grid-bg: #0d0810;
            --grid-glow: 0 0 15px #ff66aa;
            --pixel-off: #352a36;
            --pixel-on: #ff80bf;
            --pixel-glow: 0 0 12px #ff80bf, 0 0 25px #ff4da6;
            --accent: #ff99cc;
            --accent-glow: 0 0 20px #ff80bf;
            --card-bg: rgba(40, 20, 40, 0.6);
            --text: #ffe0f0;
            --btn-bg: rgba(255, 128, 191, 0.1);
            --btn-border: rgba(255, 128, 191, 0.4);
            --btn-hover: rgba(255, 128, 191, 0.25);
            --bar-fill: #ff80bf;
        }

        [data-theme="green"] {
            --theme-gradient: linear-gradient(145deg, #0f1f14, #0a130e);
            --grid-bg: #0a100c;
            --grid-glow: 0 0 15px #aaff66;
            --pixel-off: #1e3322;
            --pixel-on: #b0ff80;
            --pixel-glow: 0 0 12px #b0ff80, 0 0 25px #88ff4d;
            --accent: #c6ff99;
            --card-bg: rgba(20, 40, 20, 0.6);
            --text: #eaffea;
            --btn-bg: rgba(176, 255, 128, 0.1);
            --btn-border: rgba(176, 255, 128, 0.4);
            --btn-hover: rgba(176, 255, 128, 0.25);
            --bar-fill: #b0ff80;
        }

        [data-theme="purple"] {
            --theme-gradient: linear-gradient(145deg, #1e1a2f, #121024);
            --grid-bg: #0c0a14;
            --grid-glow: 0 0 15px #ca8eff;
            --pixel-off: #2a1f3a;
            --pixel-on: #d9b0ff;
            --pixel-glow: 0 0 12px #d9b0ff, 0 0 25px #b366ff;
            --accent: #cc99ff;
            --card-bg: rgba(30, 20, 50, 0.6);
            --text: #f3e6ff;
            --btn-bg: rgba(204, 153, 255, 0.1);
            --btn-border: rgba(204, 153, 255, 0.4);
            --btn-hover: rgba(204, 153, 255, 0.25);
            --bar-fill: #d9b0ff;
        }

        body {
            background: var(--theme-gradient);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: background 0.4s ease;
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
        }

        /* ---------- MAIN GLASS CONTAINER ---------- */
        .glass-panel {
            width: 100%;
            max-width: 800px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--glass-border);
            border-radius: 48px 48px 32px 32px;
            padding: 28px 24px;
            box-shadow: var(--glass-shadow), 0 0 0 1px rgba(255,255,255,0.05) inset;
            transition: background 0.3s, border-color 0.3s;
        }

        /* ---------- HEADER with BRUSH ---------- */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        .app-header h1 {
            font-weight: 700;
            font-size: 1.7rem;
            letter-spacing: 3px;
            text-shadow: 0 0 10px var(--accent);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .app-header h1 i {
            color: var(--accent);
            filter: drop-shadow(0 0 8px var(--accent));
        }
        .brush-selector {
            display: flex;
            gap: 8px;
            background: var(--card-bg);
            padding: 6px;
            border-radius: 40px;
            backdrop-filter: blur(8px);
            border: 1px solid var(--btn-border);
        }
        .brush-option {
            background: transparent;
            border: none;
            color: var(--text);
            padding: 8px 16px;
            border-radius: 32px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .brush-option.active-tool {
            background: var(--accent);
            color: black;
            box-shadow: 0 0 15px var(--accent);
        }

        /* ---------- GRID â€“ INVERTED, GLOWING ---------- */
        .grid-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }
        #grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 3px;
            background: var(--grid-bg);
            padding: 16px;
            border-radius: 28px;
            box-shadow: var(--grid-glow), inset 0 0 20px rgba(0,0,0,0.6);
            width: fit-content;
            transition: box-shadow 0.3s, background 0.3s;
            touch-action: none; /* crucial for mobile drawing */
        }
        .pixel {
            aspect-ratio: 1 / 1;
            width: min(24px, 5vw);
            height: min(24px, 5vw);
            background: var(--pixel-off);
            border-radius: 6px;
            transition: all 0.1s ease;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.3);
            cursor: crosshair;
        }
        .pixel.active {
            background: var(--pixel-on);
            box-shadow: var(--pixel-glow), inset 0 -2px 0 rgba(0,0,0,0.2);
            transform: scale(0.96);
        }
        .pixel:hover {
            transform: scale(0.94);
            background: var(--pixel-on);
            opacity: 0.9;
            box-shadow: 0 0 18px var(--pixel-on);
        }

        /* ---------- COMMAND BAR â€“ DIRECTLY UNDER GRID (NEXT TO BOX) ---------- */
        .command-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--btn-border);
            border-radius: 48px;
            padding: 12px 20px;
            margin-bottom: 20px;
            transition: background 0.3s, border-color 0.3s;
        }
        .glass-btn {
            background: var(--btn-bg);
            border: 1px solid var(--btn-border);
            color: var(--text);
            padding: 10px 18px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(4px);
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .glass-btn:hover {
            background: var(--btn-hover);
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent);
            transform: translateY(-2px);
        }

        /* ---------- THEME THUMBNAILS (LIVE, DYNAMIC) ---------- */
        .theme-rail {
            display: flex;
            gap: 12px;
            margin: 16px 0 12px;
            overflow-x: auto;
            padding-bottom: 6px;
        }
        .theme-thumb {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: 0.2s;
            cursor: pointer;
            backdrop-filter: blur(4px);
            min-width: 90px;
        }
        .theme-thumb.active-theme {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent);
        }
        .thumb-grid {
            display: grid;
            grid-template-columns: repeat(6, 8px);
            gap: 2px;
            background: var(--grid-bg);
            padding: 6px;
            border-radius: 10px;
            margin-bottom: 6px;
            transition: background 0.2s;
        }
        .thumb-pixel {
            width: 8px;
            height: 8px;
            background: var(--pixel-off);
            border-radius: 1.5px;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .thumb-pixel.on {
            background: var(--pixel-on);
            box-shadow: 0 0 6px var(--pixel-on);
        }
        .theme-name {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        /* ---------- PREDICTION CARDS (SLIDE IN, DEBOUNCED) ---------- */
        .prediction-deck {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 18px 0 10px;
        }
        .prediction-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--btn-border);
            border-radius: 24px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            animation: slideIn 0.25s ease-out;
            transition: background 0.3s, border-color 0.3s;
        }
        @keyframes slideIn {
            0% { opacity: 0; transform: translateX(20px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        .card-icon {
            font-size: 2rem;
            width: 50px;
            color: var(--accent);
            text-shadow: 0 0 12px var(--accent);
        }
        .card-content {
            flex: 1;
            margin-left: 12px;
        }
        .card-letter {
            font-size: 1.6rem;
            font-weight: 800;
            line-height: 1;
            color: var(--text);
        }
        .progress {
            height: 10px;
            background: var(--bar-bg);
            border-radius: 20px;
            margin: 6px 0 2px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--bar-fill);
            box-shadow: 0 0 10px var(--bar-fill);
            border-radius: 20px;
            transition: width 0.2s ease;
        }
        .card-percent {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* ---------- TEACH / PRACTICE ROW ---------- */
        .teach-panel {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        .teach-input {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--btn-border);
            border-radius: 40px;
            padding: 12px 16px;
            color: var(--text);
            font-weight: 600;
            font-size: 1.1rem;
            width: 80px;
            text-align: center;
            backdrop-filter: blur(4px);
        }
        .teach-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent);
        }

        /* ---------- SPARKLE CANVAS ---------- */
        #sparkleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* practice indicator */
        #practiceIndicator {
            margin-top: 12px;
            font-size: 1rem;
            color: var(--accent);
            text-align: center;
            font-weight: 600;
        }

        @media (max-width: 600px) {
            .glass-panel { padding: 20px 16px; }
            .command-bar { gap: 8px; }
            .glass-btn { padding: 8px 14px; }
        }
    </style>
</head>
<body data-theme="blue">
    <canvas id="sparkleCanvas"></canvas>
    <div class="glass-panel">
        <!-- HEADER with BRUSH SELECTOR -->
        <div class="app-header">
            <h1>
                <i class="fas fa-cube"></i> PXLÂ·12
            </h1>
            <div class="brush-selector">
                <div id="brush1" class="brush-option active-tool"><i class="fas fa-cube"></i>1</div>
                <div id="brush3" class="brush-option"><i class="fas fa-cubes"></i>3</div>
                <div id="brush5" class="brush-option"><i class="fas fa-cubes-stacked"></i>5</div>
            </div>
        </div>

        <!-- PIXEL GRID -->
        <div class="grid-wrapper">
            <div id="grid"></div>
        </div>

        <!-- ðŸŽ¯ COMMAND BAR â€“ DIRECTLY NEXT TO BOX (UNDO, REDO, MODE, CLEAR, RECOGNIZE) -->
        <div class="command-bar">
            <button id="undoBtn" class="glass-btn"><i class="fas fa-undo-alt"></i> Undo</button>
            <button id="redoBtn" class="glass-btn"><i class="fas fa-redo-alt"></i> Redo</button>
            <button id="modeToggle" class="glass-btn"><i class="fas fa-eraser"></i> Erase</button>
            <button id="clearBtn" class="glass-btn"><i class="fas fa-trash-alt"></i> Clear</button>
            <button id="recognizeBtn" class="glass-btn" style="background: var(--accent); color: black;"><i class="fas fa-search"></i> Recognize</button>
        </div>

        <!-- THEME THUMBNAILS (LIVE PREVIEW) -->
        <div class="theme-rail" id="themeRail"></div>

        <!-- PREDICTION CARDS -->
        <div class="prediction-deck" id="predictionDeck"></div>

        <!-- TEACH / PRACTICE / EXPORT ROW -->
        <div class="teach-panel">
            <div style="display: flex; gap: 6px; align-items: center;">
                <input type="text" id="teachLetter" class="teach-input" maxlength="1" placeholder="A">
                <button id="teachBtn" class="glass-btn"><i class="fas fa-save"></i> Teach</button>
                <button id="forgetBtn" class="glass-btn"><i class="fas fa-trash"></i> Forget</button>
            </div>
            <button id="practiceToggleBtn" class="glass-btn"><i class="fas fa-gamepad"></i> Practice</button>
            <div style="margin-left: auto; display: flex; gap: 6px;">
                <button id="exportBtn" class="glass-btn"><i class="fas fa-download"></i></button>
                <button id="importBtn" class="glass-btn"><i class="fas fa-upload"></i></button>
            </div>
        </div>

        <!-- PRACTICE FEEDBACK -->
        <div id="practiceIndicator"></div>
    </div>

    <script>
        (function() {
            "use strict";

            // ---------- CONST ----------
            const GRID_SIZE = 12;
            const TOTAL_CELLS = GRID_SIZE * GRID_SIZE;

            // ---------- STATE ----------
            let pixels = [];
            let gridState = new Array(TOTAL_CELLS).fill(0);
            let historyStack = [];
            let redoStack = [];
            const MAX_HISTORY = 30;
            let isDrawing = false;
            let mode = 'draw';
            let brushSize = 1;
            let practiceMode = false;
            let practiceLetter = 'A';
            let predictionTimeout = null;  // debounce

            // ---------- TEMPLATES ----------
            const compactShapes = {
                'A': ["01110","10001","10001","11111","10001","10001","10001"],
                'B': ["11110","10001","10001","11110","10001","10001","11110"],
                'C': ["01110","10001","10000","10000","10000","10001","01110"],
                'D': ["11110","10001","10001","10001","10001","10001","11110"],
                'E': ["11111","10000","10000","11110","10000","10000","11111"],
                'F': ["11111","10000","10000","11110","10000","10000","10000"],
                'G': ["01110","10001","10000","10111","10001","10001","01110"],
                'H': ["10001","10001","10001","11111","10001","10001","10001"],
                'I': ["11111","00100","00100","00100","00100","00100","11111"],
                'J': ["01111","00010","00010","00010","00010","10010","01100"],
                'K': ["10001","10010","10100","11000","10100","10010","10001"],
                'L': ["10000","10000","10000","10000","10000","10000","11111"],
                'M': ["10001","11011","10101","10101","10001","10001","10001"],
                'N': ["10001","11001","10101","10011","10001","10001","10001"],
                'O': ["01110","10001","10001","10001","10001","10001","01110"],
                'P': ["11110","10001","10001","11110","10000","10000","10000"],
                'Q': ["01110","10001","10001","10001","10101","10011","01110"],
                'R': ["11110","10001","10001","11110","10100","10010","10001"],
                'S': ["01111","10000","10000","01110","00001","00001","11110"],
                'T': ["11111","00100","00100","00100","00100","00100","00100"],
                'U': ["10001","10001","10001","10001","10001","10001","01110"],
                'V': ["10001","10001","10001","10001","01010","00100","00100"],
                'W': ["10001","10001","10001","10101","10101","11011","10001"],
                'X': ["10001","01010","00100","00100","00100","01010","10001"],
                'Y': ["10001","01010","00100","00100","00100","00100","00100"],
                'Z': ["11111","00010","00100","01000","10000","10000","11111"]
            };

            // base templates 12x12 & centroids
            let baseTemplates = {};
            let baseCentroids = {};
            function scale5x7To12x12(rows) {
                const h = rows.length, w = rows[0].length;
                const src = rows.map(r=> Array.from(r).map(ch=> ch==='1'?1:0));
                const flat = new Array(144).fill(0);
                for (let tr=0; tr<12; tr++) {
                    for (let tc=0; tc<12; tc++) {
                        const sr = Math.floor(tr * h / 12);
                        const sc = Math.floor(tc * w / 12);
                        flat[tr*12+tc] = src[sr][sc];
                    }
                }
                return flat;
            }
            function computeCentroid(flat) {
                let sx=0, sy=0, cnt=0;
                for (let i=0; i<144; i++) if (flat[i]) {
                    sx += i%12; sy += Math.floor(i/12); cnt++;
                }
                return cnt ? {x: sx/cnt, y: sy/cnt} : {x:6, y:6};
            }
            for (let l in compactShapes) {
                baseTemplates[l] = scale5x7To12x12(compactShapes[l]);
                baseCentroids[l] = computeCentroid(baseTemplates[l]);
            }

            // taught patterns
            let taughtTemplates = {};

            // ---------- UTILS ----------
            function getGrid2D() {
                const g = [];
                for (let r=0; r<12; r++) {
                    const row = [];
                    for (let c=0; c<12; c++) row.push(gridState[r*12+c]);
                    g.push(row);
                }
                return g;
            }

            function normalizeUserDrawing(grid2D) {
                let minR=12, maxR=-1, minC=12, maxC=-1;
                for (let r=0;r<12;r++) for (let c=0;c<12;c++) if (grid2D[r][c]) {
                    minR=Math.min(minR,r); maxR=Math.max(maxR,r);
                    minC=Math.min(minC,c); maxC=Math.max(maxC,c);
                }
                if (maxR===-1) return {flat:new Array(144).fill(0), centroid:{x:6,y:6}};
                const cropH = maxR-minR+1, cropW = maxC-minC+1;
                const cropped = [];
                for (let r=minR; r<=maxR; r++) cropped.push(grid2D[r].slice(minC, maxC+1));
                const flat = new Array(144).fill(0);
                for (let tr=0; tr<12; tr++) {
                    for (let tc=0; tc<12; tc++) {
                        const sr = Math.floor(tr * cropH / 12);
                        const sc = Math.floor(tc * cropW / 12);
                        flat[tr*12+tc] = cropped[sr][sc];
                    }
                }
                return {flat, centroid: computeCentroid(flat)};
            }

            function alignPatternByCentroid(pattern, targetCent, patternCent) {
                const shifted = new Array(144).fill(0);
                const dx = Math.round(targetCent.x - patternCent.x);
                const dy = Math.round(targetCent.y - patternCent.y);
                for (let i=0;i<144;i++) if (pattern[i]) {
                    const r = Math.floor(i/12), c = i%12;
                    const nr = r+dy, nc = c+dx;
                    if (nr>=0 && nr<12 && nc>=0 && nc<12) shifted[nr*12+nc] = 1;
                }
                return shifted;
            }

            function correlation(p, u) {
                let m=0; for(let i=0;i<144;i++) if(p[i]===u[i]) m++;
                return m/144;
            }

            // recognition engine
            function recognizeAll() {
                const g2 = getGrid2D();
                const {flat: userFlat, centroid: userCent} = normalizeUserDrawing(g2);
                let candidates = [];
                for (let l in baseTemplates) {
                    const aligned = alignPatternByCentroid(baseTemplates[l], userCent, baseCentroids[l]);
                    candidates.push({letter: l, score: correlation(aligned, userFlat), source:'base'});
                }
                for (let l in taughtTemplates) {
                    taughtTemplates[l].forEach(tf => {
                        const tc = computeCentroid(tf);
                        const aligned = alignPatternByCentroid(tf, userCent, tc);
                        candidates.push({letter: l, score: correlation(aligned, userFlat), source:'taught'});
                    });
                }
                candidates.sort((a,b)=> b.score - a.score);
                return candidates;
            }

            // ---------- DEBOUNCED UI UPDATE ----------
            function updatePredictionCards() {
                if (predictionTimeout) clearTimeout(predictionTimeout);
                predictionTimeout = setTimeout(() => {
                    const results = recognizeAll();
                    const deck = document.getElementById('predictionDeck');
                    deck.innerHTML = '';
                    for (let i=0; i<3; i++) {
                        const card = document.createElement('div');
                        card.className = 'prediction-card';
                        if (results[i]) {
                            let perc = (results[i].score * 100).toFixed(1);
                            card.innerHTML = `
                                <div class="card-icon"><i class="fas fa-cube"></i></div>
                                <div class="card-content">
                                    <div class="card-letter">${results[i].letter}</div>
                                    <div class="progress"><div class="progress-fill" style="width: ${perc}%;"></div></div>
                                    <div class="card-percent">${perc}% Â· ${results[i].source}</div>
                                </div>
                            `;
                        } else {
                            card.innerHTML = `<div class="card-icon"><i class="fas fa-question"></i></div>
                                            <div class="card-content"><div class="card-letter">?</div>
                                            <div class="progress"><div class="progress-fill" style="width:0%;"></div></div>
                                            <div class="card-percent">0%</div></div>`;
                        }
                        deck.appendChild(card);
                    }

                    // sparkles on high confidence
                    if (results.length && results[0].score > 0.88 && gridState.some(v=>v===1)) {
                        startSparkles();
                    }

                    // practice mode feedback
                    if (practiceMode && results.length && results[0].letter === practiceLetter && results[0].score > 0.8) {
                        document.getElementById('practiceIndicator').innerHTML = `<i class="fas fa-trophy"></i> CORRECT! +1`;
                        startSparkles();
                        // pick next letter after a moment
                        setTimeout(() => {
                            if (practiceMode) {
                                const letters = Object.keys(baseTemplates);
                                practiceLetter = letters[Math.floor(Math.random()*letters.length)];
                                document.getElementById('practiceIndicator').innerHTML = `<i class="fas fa-bullseye"></i> DRAW: ${practiceLetter}`;
                            }
                        }, 1200);
                    }
                }, 30); // gentle debounce
            }

            // ---------- SPARKLES (theme-aware) ----------
            const canvas = document.getElementById('sparkleCanvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            function startSparkles() {
                const theme = document.body.dataset.theme;
                let hue = 180; // blue
                if (theme === 'pink') hue = 320;
                else if (theme === 'green') hue = 100;
                else if (theme === 'purple') hue = 270;
                for (let i=0;i<25;i++) particles.push({
                    x: Math.random() * window.innerWidth,
                    y: window.innerHeight + 20,
                    size: Math.random() * 8 + 4,
                    speedX: (Math.random()-0.5)*2,
                    speedY: -Math.random()*6 - 5,
                    color: `hsla(${hue + Math.random()*30 - 15}, 80%, 70%, 0.9)`,
                    life: 1.0
                });
                if (!window.sparkleActive) {
                    window.sparkleActive = true;
                    requestAnimationFrame(drawSparkles);
                }
            }
            function drawSparkles() {
                if (particles.length===0) { window.sparkleActive = false; return; }
                ctx.clearRect(0,0,canvas.width,canvas.height);
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                for (let i=particles.length-1; i>=0; i--) {
                    const p = particles[i];
                    p.x += p.speedX;
                    p.y += p.speedY;
                    p.life -= 0.012;
                    if (p.y < -30 || p.life <= 0) { particles.splice(i,1); continue; }
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 15;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.shadowBlur = 0;
                if (particles.length) requestAnimationFrame(drawSparkles);
                else window.sparkleActive = false;
            }

            // ---------- GRID STATE & HISTORY (skip no-change) ----------
            function setGridState(newState, skipHistory = false) {
                const changed = gridState.some((v,i)=> v !== newState[i]);
                if (!changed) return;
                if (!skipHistory) pushHistory();
                gridState = [...newState];
                for (let i=0;i<TOTAL_CELLS;i++) {
                    if (gridState[i]) pixels[i].classList.add('active');
                    else pixels[i].classList.remove('active');
                }
                updatePredictionCards();
            }
            function pushHistory() {
                redoStack = [];
                historyStack.push([...gridState]);
                if (historyStack.length > MAX_HISTORY) historyStack.shift();
            }
            function undo() {
                if (historyStack.length) {
                    redoStack.push([...gridState]);
                    setGridState(historyStack.pop(), true);
                }
            }
            function redo() {
                if (redoStack.length) {
                    historyStack.push([...gridState]);
                    setGridState(redoStack.pop(), true);
                }
            }

            // drawing
            function paintAt(index) {
                const row = Math.floor(index/12), col = index%12;
                const half = Math.floor(brushSize/2);
                let changed = false;
                for (let dr=-half; dr<=half; dr++) {
                    for (let dc=-half; dc<=half; dc++) {
                        const nr = row+dr, nc = col+dc;
                        if (nr>=0 && nr<12 && nc>=0 && nc<12) {
                            const idx = nr*12+nc;
                            if (mode==='draw' && gridState[idx]===0) {
                                gridState[idx]=1;
                                pixels[idx].classList.add('active');
                                changed = true;
                            } else if (mode==='erase' && gridState[idx]===1) {
                                gridState[idx]=0;
                                pixels[idx].classList.remove('active');
                                changed = true;
                            }
                        }
                    }
                }
                if (changed) {
                    pushHistory();
                    updatePredictionCards();
                }
            }

            // handlers
            function handleStart(e) {
                e.preventDefault();
                isDrawing = true;
                const target = e.target.closest('.pixel');
                if (target) paintAt(pixels.indexOf(target));
            }
            function handleMove(e) {
                e.preventDefault();
                if (!isDrawing) return;
                const target = e.target.closest('.pixel');
                if (target) paintAt(pixels.indexOf(target));
            }

            // clear
            function clearAll() {
                const empty = new Array(TOTAL_CELLS).fill(0);
                setGridState(empty);
            }

            // init grid
            function initGrid() {
                const gridEl = document.getElementById('grid');
                gridEl.innerHTML = '';
                pixels = [];
                for (let i=0;i<TOTAL_CELLS;i++) {
                    const p = document.createElement('div');
                    p.className = 'pixel';
                    gridEl.appendChild(p);
                    pixels.push(p);
                }
                gridEl.addEventListener('mousedown', handleStart);
                gridEl.addEventListener('mousemove', handleMove);
                gridEl.addEventListener('mouseup', ()=> isDrawing=false);
                gridEl.addEventListener('mouseleave', ()=> isDrawing=false);
                gridEl.addEventListener('touchstart', handleStart);
                gridEl.addEventListener('touchmove', handleMove);
                gridEl.addEventListener('touchend', ()=> isDrawing=false);
                gridEl.addEventListener('touchcancel', ()=> isDrawing=false);
                clearAll();
                pushHistory();
            }

            // ---------- THEME with LIVE THUMBNAILS ----------
            const themes = [
                { id: 'blue', name: 'CYBER' },
                { id: 'pink', name: 'NEON' },
                { id: 'green', name: 'ACID' },
                { id: 'purple', name: 'PLASMA' }
            ];
            function buildThemeThumbnails() {
                const rail = document.getElementById('themeRail');
                rail.innerHTML = '';
                themes.forEach(theme => {
                    const thumb = document.createElement('div');
                    thumb.className = `theme-thumb ${theme.id === 'blue' ? 'active-theme' : ''}`;
                    thumb.dataset.theme = theme.id;
                    // dynamic innerHTML â€” will be updated when theme changes
                    thumb.innerHTML = `
                        <div class="thumb-grid" id="thumb-${theme.id}">
                            ${'<div class="thumb-pixel"></div>'.repeat(36)}
                        </div>
                        <span class="theme-name">${theme.name}</span>
                    `;
                    thumb.onclick = () => setTheme(theme.id);
                    rail.appendChild(thumb);
                });
                // initial paint of thumbnails with current theme colors
                applyThemeToThumbnails();
            }

            function applyThemeToThumbnails() {
                // For each theme, we need to style its thumb pixels using the theme's CSS variables
                // Since we can't read computed style of unapplied themes easily, we'll set inline styles
                // based on known theme colors.
                const themeColors = {
                    blue: { grid: '#0a0e14', off: '#1e2a36', on: '#00f0ff' },
                    pink: { grid: '#0d0810', off: '#352a36', on: '#ff80bf' },
                    green: { grid: '#0a100c', off: '#1e3322', on: '#b0ff80' },
                    purple: { grid: '#0c0a14', off: '#2a1f3a', on: '#d9b0ff' }
                };
                themes.forEach(theme => {
                    const thumbGrid = document.getElementById(`thumb-${theme.id}`);
                    if (!thumbGrid) return;
                    const colors = themeColors[theme.id];
                    thumbGrid.style.background = colors.grid;
                    const pixels = thumbGrid.querySelectorAll('.thumb-pixel');
                    // set a sample pattern (letter 'A' simplified) to make it recognisable
                    const sample = [7,8,13,14,15,16,19,20,21,22,25,26,27,28,31,32,33,34]; // 6x6 indices
                    pixels.forEach((p, idx) => {
                        p.style.background = sample.includes(idx) ? colors.on : colors.off;
                        p.style.boxShadow = sample.includes(idx) ? `0 0 6px ${colors.on}` : 'none';
                    });
                });
            }

            function setTheme(themeId) {
                document.body.dataset.theme = themeId;
                document.querySelectorAll('.theme-thumb').forEach(th => th.classList.remove('active-theme'));
                document.querySelector(`.theme-thumb[data-theme="${themeId}"]`).classList.add('active-theme');
                // thumb colors are already set via CSS variables? No, inline styles are static.
                // We need to update the inline styles to match the new theme's colors for each thumbnail.
                applyThemeToThumbnails();
                updatePredictionCards(); 
            }

            // ---------- TEACH (no empty) ----------
            function teachCurrent(letter) {
                if (!letter || letter.length!==1) return;
                letter = letter.toUpperCase();
                const {flat} = normalizeUserDrawing(getGrid2D());
                if (!flat.some(v=>v===1)) {
                    alert('Draw something first!');
                    return;
                }
                if (!taughtTemplates[letter]) taughtTemplates[letter] = [];
                taughtTemplates[letter].push(flat);
                if (taughtTemplates[letter].length > 5) taughtTemplates[letter].shift();
                saveTaught();
                updatePredictionCards();
            }
            function forgetTaught(letter) {
                if (!letter || letter.length!==1) return;
                letter = letter.toUpperCase();
                if (taughtTemplates[letter]) { delete taughtTemplates[letter]; saveTaught(); updatePredictionCards(); }
            }

            // storage
            function loadTaught() {
                const stored = localStorage.getItem('neonAlphabetTaught');
                if (stored) { try { taughtTemplates = JSON.parse(stored); } catch(e){} }
            }
            function saveTaught() { localStorage.setItem('neonAlphabetTaught', JSON.stringify(taughtTemplates)); }

            // practice toggle
            function togglePractice() {
                practiceMode = !practiceMode;
                const btn = document.getElementById('practiceToggleBtn');
                const indicator = document.getElementById('practiceIndicator');
                if (practiceMode) {
                    const letters = Object.keys(baseTemplates);
                    practiceLetter = letters[Math.floor(Math.random()*letters.length)];
                    indicator.innerHTML = `<i class="fas fa-bullseye"></i> DRAW: ${practiceLetter}`;
                    btn.innerHTML = '<i class="fas fa-gamepad"></i> Practice ON';
                } else {
                    indicator.innerHTML = '';
                    btn.innerHTML = '<i class="fas fa-gamepad"></i> Practice';
                }
            }

            // export/import
            function exportData() {
                const blob = new Blob([JSON.stringify(taughtTemplates)], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'neon_alphabets.json'; a.click();
            }
            function importData(file) {
                const reader = new FileReader();
                reader.onload = (e) => { 
                    try { 
                        taughtTemplates = JSON.parse(e.target.result); 
                        saveTaught(); 
                        updatePredictionCards(); 
                        alert('Imported!'); 
                    } catch(e) { alert('Invalid file'); } 
                };
                reader.readAsText(file);
            }

            // ---------- BOOTSTRAP ----------
            window.onload = function() {
                initGrid();
                loadTaught();
                buildThemeThumbnails();
                setTheme('blue');

                // brush buttons
                document.getElementById('brush1').onclick = function() { 
                    brushSize=1; 
                    document.querySelectorAll('.brush-option').forEach(b=>b.classList.remove('active-tool'));
                    this.classList.add('active-tool');
                };
                document.getElementById('brush3').onclick = function() { 
                    brushSize=3; 
                    document.querySelectorAll('.brush-option').forEach(b=>b.classList.remove('active-tool'));
                    this.classList.add('active-tool');
                };
                document.getElementById('brush5').onclick = function() { 
                    brushSize=5; 
                    document.querySelectorAll('.brush-option').forEach(b=>b.classList.remove('active-tool'));
                    this.classList.add('active-tool');
                };

                // command bar buttons
                document.getElementById('undoBtn').onclick = undo;
                document.getElementById('redoBtn').onclick = redo;
                document.getElementById('clearBtn').onclick = clearAll;
                document.getElementById('modeToggle').onclick = function() {
                    mode = mode==='draw'? 'erase' : 'draw';
                    this.innerHTML = mode==='draw'? '<i class="fas fa-eraser"></i> Erase' : '<i class="fas fa-paint-brush"></i> Draw';
                };
                document.getElementById('recognizeBtn').onclick = function() {
                    updatePredictionCards();
                    startSparkles();
                };

                // teach
                document.getElementById('teachBtn').onclick = ()=> teachCurrent(document.getElementById('teachLetter').value);
                document.getElementById('forgetBtn').onclick = ()=> forgetTaught(document.getElementById('teachLetter').value);
                document.getElementById('practiceToggleBtn').onclick = togglePractice;
                document.getElementById('exportBtn').onclick = exportData;
                document.getElementById('importBtn').onclick = ()=>{
                    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json';
                    inp.onchange = e => importData(e.target.files[0]);
                    inp.click();
                };

                updatePredictionCards();
                pushHistory();
            };
        })();
    </script>
</body>
</html>